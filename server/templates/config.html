{% extends "base.html" %}

{% block title %}配置總覽 - AutoPteroBK{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-10">
        <div class="alert alert-light border shadow-sm d-flex align-items-center mb-4" role="alert">
            <i class="fas fa-info-circle text-primary fs-4 me-3"></i>
            <div>
                <h6 class="alert-heading fw-bold mb-1">關於配置修改</h6>
                <p class="mb-0 text-muted small">此頁面僅展示當前運行的配置。如需修改，請直接編輯 <code>config.json</code> 文件並重啟應用程序。</p>
            </div>
        </div>

        <div class="row g-4">
            <div class="col-md-6">
                <div class="card h-100 shadow-sm border-0">
                    <div class="card-header bg-white border-0 pt-4 px-4 pb-0">
                        <h6 class="fw-bold text-dark d-flex align-items-center">
                            <span class="bg-primary-subtle p-2 rounded me-2">
                                <i class="fas fa-network-wired text-primary"></i>
                            </span>
                            連線配置
                        </h6>
                    </div>
                    <div class="card-body p-4">
                        <div class="mb-4">
                            <label class="d-block text-muted small fw-semibold text-uppercase mb-1">服務器綁定</label>
                            <div class="d-flex align-items-center">
                                <code class="fs-5 text-dark bg-light px-2 py-1 rounded">{{ config_data.host }}:{{ config_data.port }}</code>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <label class="d-block text-muted small fw-semibold text-uppercase mb-1">Pterodactyl URL</label>
                            <div class="text-truncate">
                                <a href="{{ config_data.base_url }}" target="_blank" class="text-decoration-none fw-medium">
                                    {{ config_data.base_url }} <i class="fas fa-external-link-alt small ms-1"></i>
                                </a>
                            </div>
                        </div>

                        <div>
                            <label class="d-block text-muted small fw-semibold text-uppercase mb-1">API Key</label>
                            <div class="d-flex align-items-center bg-light p-2 rounded">
                                <i class="fas fa-key text-muted me-2"></i>
                                <code class="text-muted text-break" style="font-size: 0.8rem;">
                                    {{ config_data.api_key[:8] }}••••••••••••••••{{ config_data.api_key[-6:] }}
                                </code>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card h-100 shadow-sm border-0">
                    <div class="card-header bg-white border-0 pt-4 px-4 pb-0">
                        <h6 class="fw-bold text-dark d-flex align-items-center">
                            <span class="bg-success-subtle p-2 rounded me-2">
                                <i class="fas fa-hdd text-success"></i>
                            </span>
                            存儲設定
                        </h6>
                    </div>
                    <div class="card-body p-4">
                        <div class="mb-4">
                            <label class="d-block text-muted small fw-semibold text-uppercase mb-1">數據存儲路徑</label>
                            <div class="bg-light p-2 rounded">
                                <code class="text-dark">{{ config_data.data_path }}</code>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-6">
                                <label class="d-block text-muted small fw-semibold text-uppercase mb-1">最大備份大小</label>
                                <h4 class="fw-bold text-dark mb-0 d-flex align-items-baseline">
                                    {{ config_data.max_size }} 
                                    <span class="fs-6 text-muted ms-1">GB</span>
                                </h4>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-12">
                <div class="card shadow-sm border-0">
                     <div class="card-header bg-white border-0 pt-4 px-4 pb-0">
                        <h6 class="fw-bold text-dark d-flex align-items-center">
                            <span class="bg-warning-subtle p-2 rounded me-2">
                                <i class="fas fa-shield-alt text-warning"></i>
                            </span>
                            規則
                        </h6>
                    </div>
                    <div class="card-body p-4">
                        <div class="row">
                            <div class="col-md-6 mb-4 mb-md-0">
                                <h6 class="text-dark fw-bold mb-3 small text-uppercase">排除規則</h6>
                                <div class="d-flex flex-wrap gap-2">
                                    {% for exclude in config_data.system_exclude %}
                                        <span class="badge bg-secondary-subtle text-dark border fw-normal px-3 py-2">
                                            {{ exclude }}
                                        </span>
                                    {% endfor %}
                                </div>
                                <p class="text-muted small mt-2">這些規則適用於所有伺服器備份。</p>
                            </div>
                            
                            {% if config_data.account %}
                            <div class="col-md-6">
                                <h6 class="text-dark fw-bold mb-3 small text-uppercase">管理員帳戶</h6>
                                <div class="bg-light p-3 rounded d-flex align-items-center border">
                                    <div class="bg-white p-2 rounded-circle shadow-sm me-3">
                                        <i class="fas fa-user text-secondary"></i>
                                    </div>
                                    <div>
                                        <div class="text-xs text-muted">當前登錄帳戶</div>
                                        <div class="fw-bold">{{ config_data.account.username }}</div>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-12">
                <div class="card shadow-sm border-0">
                    <div class="card-header bg-white border-0 pt-4 px-4 pb-0">
                        <h6 class="fw-bold text-dark d-flex align-items-center">
                            <span class="bg-info-subtle p-2 rounded me-2">
                                <i class="fas fa-terminal text-info"></i>
                            </span>
                            用戶端一鍵安裝
                        </h6>
                    </div>
                    <div class="card-body p-4">
                        <p class="text-muted small mb-3">在需要備份的 Wings 節點伺服器上執行以下命令，即可自動安裝並配置用戶端：</p>
                        
                        <div class="position-relative">
                            <pre class="bg-dark text-light p-3 rounded mb-0" style="font-size: 0.85rem; overflow-x: auto;"><code id="installCommand">curl -sSL https://raw.githubusercontent.com/HansHans135/autopterobk/main/install.sh | sudo bash -s client --url {{ request.url_root.rstrip('/') }} --key {{ config_data.key }}</code></pre>
                            <button class="btn btn-sm btn-outline-light position-absolute top-0 end-0 m-2" onclick="copyInstallCommand(this)" title="複製命令">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                        
                        <div class="mt-3">
                            <div class="row g-2">
                                <div class="col-md-6">
                                    <div class="bg-light p-2 rounded border">
                                        <small class="text-muted d-block">伺服端網址</small>
                                        <code class="text-primary">{{ request.url_root.rstrip('/') }}</code>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="bg-light p-2 rounded border">
                                        <small class="text-muted d-block">API Key</small>
                                        <code class="text-success">{{ config_data.key[:8] }}••••••••{{ config_data.key[-6:] }}</code>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="alert alert-info mt-3 mb-0 small">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>提示：</strong>複製上方指令後直接在 Wings 節點伺服器上執行即可完成用戶端安裝。
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-12">
                 <div class="accordion shadow-sm" id="configJsonAccordion">
                    <div class="accordion-item border-0 overflow-hidden rounded">
                        <h2 class="accordion-header" id="headingOne">
                            <button class="accordion-button collapsed bg-white fw-bold" type="button" data-bs-toggle="collapse" data-bs-target="#collapseJson" aria-expanded="false" aria-controls="collapseJson">
                                <i class="fas fa-code text-muted me-2"></i> 查看原始 JSON 配置
                            </button>
                        </h2>
                        <div id="collapseJson" class="accordion-collapse collapse" aria-labelledby="headingOne" data-bs-parent="#configJsonAccordion">
                            <div class="accordion-body bg-light p-0">
                                <pre class="m-0 p-3 text-muted border-top border-0 rounded-0" style="max-height: 300px;"><code>{{ config_data|tojson(indent=2) }}</code></pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<script>
function copyInstallCommand(btn) {
    const command = document.getElementById('installCommand').textContent;
    
    function showSuccess() {
        const originalHtml = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-check"></i>';
        btn.classList.remove('btn-outline-light');
        btn.classList.add('btn-success');
        setTimeout(() => {
            btn.innerHTML = originalHtml;
            btn.classList.remove('btn-success');
            btn.classList.add('btn-outline-light');
        }, 2000);
    }
    
    function fallbackCopy() {
        const textArea = document.createElement('textarea');
        textArea.value = command;
        textArea.style.position = 'fixed';
        textArea.style.left = '-9999px';
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        try {
            document.execCommand('copy');
            showSuccess();
        } catch (err) {
            alert('複製失敗，請手動複製');
        }
        document.body.removeChild(textArea);
    }
    
    // 檢查是否支援 Clipboard API
    if (navigator.clipboard && typeof navigator.clipboard.writeText === 'function') {
        navigator.clipboard.writeText(command).then(showSuccess).catch(fallbackCopy);
    } else {
        fallbackCopy();
    }
}
</script>
{% endblock %}
